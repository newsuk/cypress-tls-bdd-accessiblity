# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs:
  slack: circleci/slack@4.12.5
  # lighthouse-check: foo-software/lighthouse-check@0.0.8
slack-fail-post-step: &slack-fail-post-step
  context:
    - tls-production-health-check-context
  post-steps:
    - slack/notify:
        branch_pattern: .+
        event: fail
        template: basic_fail_1
        mentions: '@stdev'
        channel: C05PJHA3NTD
jobs:
  production-health-check-tests:
    machine: true
    resource_class: nukengprod/pubsys-circleci-runner-dev
    # docker:
    #   - image: cimg/base:2023.08
    steps:
      - checkout
      # install dependencies
      - run:
          name: Install Dependencies
          command: |
              cd TLS_E2E_Automation 
              npm install
      - run:
          name: Install Cypress 
          command: |
            pwd
            cd TLS_E2E_Automation
            npm add cypress --dev 
            npm add -D cypress-wait-until
      - run:
          name: Run production health check tests
          command: |
            pwd
            cd TLS_E2E_Automation
            pwd
            npm run cypress:run-healthcheck
      - run :
          name: Generating cucmber report
          when: always
          command : |
            pwd
            cd TLS_E2E_Automation
            pwd
            node ./cypress/support/cucumberreport.js
      - run :      
          name: Compressing Report
          when: always
          command: |
            pwd
            cd TLS_E2E_Automation
            pwd
            echo "${CIRCLE_WORKFLOW_JOB_ID}"
            tar -cvzf ./cypress/cucmberReport.tar cucumberreports
      - store_artifacts:
          path: TLS_E2E_Automation/cypress/productionhealthcheckscreenshots
      - store_artifacts:
          path: TLS_E2E_Automation/cypress/videos
      - store_artifacts:
          path:  TLS_E2E_Automation/cypress/cucmberReport.tar
      - run:
          name: Send Cucumber report to Slack
          when: on_fail
          command: |
            pwd
            cd TLS_E2E_Automation
            ls
            message="https://output.circle-artifacts.com/output/job/${CIRCLE_WORKFLOW_JOB_ID}/artifacts/0/TLS_E2E_Automation/cypress/cucmberReport.tar"
            
            curl -X POST -H 'Content-type: application/json' --data '{
            "channel": "C05PJHA3NTD",
            "username": "CircleCI",
            "text": "*Cucumber Test Report*",
            "attachments": [
            {
            "color": "#FF0000",
            "fields": [
            {
             "title": "Build number",
             "value": "'"$CIRCLE_BUILD_NUM"'",
             "short": true
            },
            {
             "title": "Report Link",
             "value": "'"$message"'",
             "short": false
            }
            ]
            }
            ]
            }' "$SLACK_WEBHOOK_URL"
workflows:
  tests:
    jobs:
      - production-health-check-tests:
          <<: *slack-fail-post-step